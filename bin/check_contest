#!/usr/bin/env ruby

require "rubygems"
require "bundler/setup"

require "oga"
require "net/http"
require "uri"
require "date"

def url(page_number = nil)
  if page_number
    $base_url + "&perpage=40&pagenumber=#{page_number}"
  else
    $base_url
  end
end

def make_link(href, page_number = nil)
  if href.start_with?("#")
    url(page_number) + href
  else
    href
  end
end

$base_url = "https://forums.somethingawful.com/showthread.php?threadid=3878560"
document = Oga.parse_html(Net::HTTP.get(URI(url)))

page_numbers = [nil, 2]
posts = page_numbers.each_with_object([]) do |page_number, array|
  puts "Loading page #{url(page_number)}"

  document = Oga.parse_html(Net::HTTP.get(URI(url(page_number))))
  document.css(".post").each_with_index do |post, index|
    author = post.at_css(".author").text
    next if author == "Adbot"
    next if index <= 4 && page_number.nil?
    next if author == "Jaded Burnout"

    array << {
      author: author,
      link: make_link(post.css(".postdate a").first.get("href"), page_number),
      timestamp: DateTime.parse(post.at_css(".postdate").text),
    }
  end
end

posts.each_with_index do |post, index|
  end_stamp = post[:timestamp] + 1 # 1 day later
  next if index > 0 && end_stamp >= DateTime.now
  number_of_posts = posts.select { |p| p[:timestamp] <= end_stamp }.count - index
  p number_of_posts
end
