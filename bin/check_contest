#!/usr/bin/env ruby

require "rubygems"
require "bundler/setup"

require "oga"
require "net/http"
require "uri"
require "time"

def url(page_number = nil)
  if page_number
    $base_url + "&perpage=40&pagenumber=#{page_number}"
  else
    $base_url
  end
end

def make_link(href, page_number = nil)
  if href.start_with?("#")
    url(page_number) + href
  else
    href
  end
end

$base_url = "https://forums.somethingawful.com/showthread.php?threadid=3878560"
document = Oga.parse_html(Net::HTTP.get(URI(url)))

page_numbers = [nil, 2, 3]
posts = page_numbers.each_with_object([]) do |page_number, array|
  puts "Loading page #{url(page_number)}"

  document = Oga.parse_html(Net::HTTP.get(URI(url(page_number))))
  document.css(".post").each_with_index do |post, index|
    author = post.at_css(".author").text
    next if author == "Adbot"
    next if index <= 4 && page_number.nil?
    next if author == "Jaded Burnout"

    array << {
      author: author,
      link: make_link(post.css(".postdate a").first.get("href"), page_number),
      timestamp: Time.parse(post.at_css(".postdate").text),
    }
  end
end


start_time = posts.first[:timestamp]
end_time = Time.now

while start_time < end_time
  end_stamp = start_time + (60 * 60 * 24)

  if start_time == posts.first[:timestamp] || end_stamp < end_time
    count = posts.select { |p| start_time <= p[:timestamp] && p[:timestamp] <= end_stamp }.count
    puts "#{start_time.strftime("%F %R")} -> #{end_stamp.strftime("%F %R")}: #{count}"
  end

  start_time += (60 * 10)
end
